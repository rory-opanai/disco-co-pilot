"use strict";(()=>{var e={};e.id=599,e.ids=[599],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},8678:e=>{e.exports=import("pg")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},9557:e=>{e.exports=require("node:stream/web")},3503:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>c,requestAsyncStorage:()=>u,routeModule:()=>d,serverHooks:()=>_,staticGenerationAsyncStorage:()=>l});var i=r(3277),o=r(5265),n=r(5356),a=r(3397),p=e([a]);a=(p.then?(await p)():p)[0];let d=new i.AppRouteRouteModule({definition:{kind:o.x.APP_ROUTE,page:"/api/postcall/[sessionId]/route",pathname:"/api/postcall/[sessionId]",filename:"route",bundlePath:"app/api/postcall/[sessionId]/route"},resolvedPagePath:"/Users/roryh/Github/DiscoCoPilot2/disco-co-pilot/frontend/app/api/postcall/[sessionId]/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:u,staticGenerationAsyncStorage:l,serverHooks:_}=d,y="/api/postcall/[sessionId]/route";function c(){return(0,n.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:l})}s()}catch(e){s(e)}})},3397:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{GET:()=>p,POST:()=>c,runtime:()=>d});var i=r(7076),o=r(2290),n=r(8625),a=e([n]);n=(a.then?(await a)():a)[0];let d="nodejs";async function p(e,{params:t}){let{sessionId:r}=t,{rows:s}=await (0,n.I)("SELECT content FROM transcripts WHERE session_id=$1 ORDER BY created_at DESC LIMIT 1",[r]),{rows:o}=await (0,n.I)("SELECT payload FROM summary_packs WHERE session_id=$1 ORDER BY created_at DESC LIMIT 1",[r]);return i.NextResponse.json({transcript:s[0]?.content||null,summary:o[0]?.payload||null})}async function c(e,{params:t}){try{let{sessionId:r}=t,s=(await e.formData()).get("audio");if(!s)return i.NextResponse.json({error:"missing audio"},{status:400});let a=(0,o.P_)(),p=(await a.audio.transcriptions.create({file:s,model:o.YK})).text,c=`Transcript (verbatim):
${p}`,d=await a.responses.create({model:o.OM,input:[{role:"system",content:"You produce a structured discovery summary JSON. Follow the provided JSON schema strictly. If any section cannot be generated, set it to null and include missing_reason at root with explanation."},{role:"user",content:c}],response_format:{type:"json_schema",json_schema:{name:"summary_pack",schema:{type:"object",properties:{coverage_table:{type:"array",items:{type:"object",properties:{category:{type:"string"},status:{type:"string"},evidence:{type:"array",items:{type:"string"}}},required:["category","status","evidence"]}},missed_questions:{type:"array",items:{type:"object",properties:{question:{type:"string"},expected_category:{type:"string"},reason_for_omission:{type:"string"}},required:["question","expected_category","reason_for_omission"]}},risks_and_blockers:{type:"array",items:{type:"object",properties:{description:{type:"string"},impact_level:{type:"string"},linked_to:{type:"string"}},required:["description","impact_level","linked_to"]}},recommended_agenda:{type:"array",items:{type:"object",properties:{agenda_item:{type:"string"},objective:{type:"string"},priority:{type:"number"}},required:["agenda_item","objective","priority"]}},follow_up_email:{type:"object",properties:{subject:{type:"string"},body:{type:"string"},action_items:{type:"array",items:{type:"string"}}},required:["subject","body","action_items"]},demo_plan_suggestions:{type:"array",items:{type:"object",properties:{suggestion:{type:"string"},justification:{type:"string"}},required:["suggestion","justification"]}},discovery_depth_score:{type:"object",properties:{percentage:{type:"number"},interpretation:{type:"string"}},required:["percentage","interpretation"]},missing_reason:{type:"string"}},required:["coverage_table","missed_questions","risks_and_blockers","recommended_agenda","follow_up_email","demo_plan_suggestions","discovery_depth_score"]},strict:!0}}}),u=d.output_text?.trim(),l=u?JSON.parse(u):{coverage_table:null,missed_questions:null,risks_and_blockers:null,recommended_agenda:null,follow_up_email:null,demo_plan_suggestions:null,discovery_depth_score:null,missing_reason:"No output"};await (0,n.I)("INSERT INTO sessions(id, created_at, finalized_at) VALUES($1, NOW(), NOW()) ON CONFLICT (id) DO UPDATE SET finalized_at = NOW()",[r]);let{rows:_}=await (0,n.I)("INSERT INTO transcripts(session_id, content) VALUES($1, $2) RETURNING id",[r,p]);return await (0,n.I)("INSERT INTO summary_packs(session_id, payload) VALUES($1, $2)",[r,l]),l.discovery_depth_score&&await (0,n.I)("INSERT INTO depth_scores(session_id, percentage, interpretation) VALUES($1, $2, $3)",[r,l.discovery_depth_score.percentage,l.discovery_depth_score.interpretation]),i.NextResponse.json({sessionId:r,transcriptId:_[0]?.id,summary:l})}catch(e){return i.NextResponse.json({error:e.message||"internal"},{status:500})}}s()}catch(e){s(e)}})},8625:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.d(t,{I:()=>n});var i=r(8678),o=e([i]);i=(o.then?(await o)():o)[0];let a=process.env.DATABASE_URL;a||console.warn("DATABASE_URL not set; DB routes will fail until configured.");let p=new i.Pool({connectionString:a,ssl:process.env.PGSSL?.toLowerCase()!=="disable"&&{rejectUnauthorized:!1}});async function n(e,t){let r=await p.connect();try{return{rows:(await r.query(e,t)).rows}}finally{r.release()}}s()}catch(e){s(e)}})},2290:(e,t,r)=>{r.d(t,{Cv:()=>o,OM:()=>n,P_:()=>i,Y$:()=>p,YK:()=>a});var s=r(1683);function i(){let e=process.env.OPENAI_API_KEY;if(!e)throw Error("OPENAI_API_KEY is not set");return new s.ZP({apiKey:e})}let o=process.env.REALTIME_MODEL||process.env.NEXT_PUBLIC_REALTIME_MODEL||"gpt-4o-realtime-preview-2024-12-17",n=process.env.RESPONSES_MODEL||"gpt-4o-mini",a=process.env.TRANSCRIBE_MODEL||"gpt-4o-mini-transcribe",p=process.env.EMBEDDING_MODEL||"text-embedding-3-small"}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[942,860],()=>r(3503));module.exports=s})();