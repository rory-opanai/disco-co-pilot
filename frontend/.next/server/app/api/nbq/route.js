"use strict";(()=>{var e={};e.id=303,e.ids=[303],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},2048:e=>{e.exports=require("fs")},2615:e=>{e.exports=require("http")},5240:e=>{e.exports=require("https")},5315:e=>{e.exports=require("path")},8621:e=>{e.exports=require("punycode")},6162:e=>{e.exports=require("stream")},7360:e=>{e.exports=require("url")},1764:e=>{e.exports=require("util")},2623:e=>{e.exports=require("worker_threads")},1568:e=>{e.exports=require("zlib")},8678:e=>{e.exports=import("pg")},7561:e=>{e.exports=require("node:fs")},4492:e=>{e.exports=require("node:stream")},9557:e=>{e.exports=require("node:stream/web")},6278:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{originalPathname:()=>y,patchFetch:()=>u,requestAsyncStorage:()=>d,routeModule:()=>p,serverHooks:()=>m,staticGenerationAsyncStorage:()=>l});var o=r(3277),s=r(5265),i=r(5356),a=r(307),c=e([a]);a=(c.then?(await c)():c)[0];let p=new o.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/nbq/route",pathname:"/api/nbq",filename:"route",bundlePath:"app/api/nbq/route"},resolvedPagePath:"/Users/roryh/Github/DiscoCoPilot2/disco-co-pilot/frontend/app/api/nbq/route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:d,staticGenerationAsyncStorage:l,serverHooks:m}=p,y="/api/nbq/route";function u(){return(0,i.patchFetch)({serverHooks:m,staticGenerationAsyncStorage:l})}n()}catch(e){n(e)}})},307:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.r(t),r.d(t,{POST:()=>c,runtime:()=>u});var o=r(7076),s=r(2290),i=r(8810),a=e([i]);i=(a.then?(await a)():a)[0];let u="nodejs";async function c(e){try{let{lastUtterance:t,checklist:r}=await e.json()||{};if(!t)return o.NextResponse.json({error:"lastUtterance required"},{status:400});let n=await (0,i.g)(t,5),a=`You are a discovery co-pilot. Propose ONE next best question (NBQ) to advance discovery with B2B customers.
Rules:
- Be concise, single sentence.
- Target a checklist gap if present.
- Ground in the last customer comment and retrieved playbook snippets.
- Output strict JSON with keys: question, grounded_in, checklist_category, confidence (0..1).`,c=`Last customer comment: ${t}
Checklist status: ${JSON.stringify(r||{})}
Retrieved playbooks:
${n.map(e=>`Title: ${e.title}
${e.content}`).join("\n---\n")}`,u=(0,s.P_)(),p=await u.responses.create({model:s.OM,input:[{role:"system",content:a},{role:"user",content:c}],response_format:{type:"json_schema",json_schema:{name:"nbq",schema:{type:"object",properties:{question:{type:"string"},grounded_in:{type:"string"},checklist_category:{type:"string"},confidence:{type:"number"}},required:["question","grounded_in","checklist_category","confidence"]},strict:!0}}}),d=p.output_text?.trim();if(!d)return o.NextResponse.json({nbq:null});let l=JSON.parse(d),m={id:`nbq_${Date.now()}`,question:l.question,grounded_in:l.grounded_in||"last_customer_comment",checklist_category:l.checklist_category||"General",confidence:"number"==typeof l.confidence?l.confidence:.7};return o.NextResponse.json({nbq:m})}catch(e){return o.NextResponse.json({error:e.message||"internal"},{status:500})}}n()}catch(e){n(e)}})},8625:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{I:()=>i});var o=r(8678),s=e([o]);o=(s.then?(await s)():s)[0];let a=process.env.DATABASE_URL;a||console.warn("DATABASE_URL not set; DB routes will fail until configured.");let c=new o.Pool({connectionString:a,ssl:process.env.PGSSL?.toLowerCase()!=="disable"&&{rejectUnauthorized:!1}});async function i(e,t){let r=await c.connect();try{return{rows:(await r.query(e,t)).rows}}finally{r.release()}}n()}catch(e){n(e)}})},2290:(e,t,r)=>{r.d(t,{Cv:()=>s,OM:()=>i,P_:()=>o,Y$:()=>c,YK:()=>a});var n=r(1683);function o(){let e=process.env.OPENAI_API_KEY;if(!e)throw Error("OPENAI_API_KEY is not set");return new n.ZP({apiKey:e})}let s=process.env.REALTIME_MODEL||process.env.NEXT_PUBLIC_REALTIME_MODEL||"gpt-4o-realtime-preview-2024-12-17",i=process.env.RESPONSES_MODEL||"gpt-4o-mini",a=process.env.TRANSCRIBE_MODEL||"gpt-4o-mini-transcribe",c=process.env.EMBEDDING_MODEL||"text-embedding-3-small"},8810:(e,t,r)=>{r.a(e,async(e,n)=>{try{r.d(t,{g:()=>c});var o=r(2290),s=r(8625),i=e([s]);async function a(e){let t=(0,o.P_)();return(await t.embeddings.create({model:o.Y$,input:e})).data.map(e=>e.embedding)}async function c(e,t=5){let[r]=await a([e]),n=`[${r.join(",")}]`,{rows:o}=await (0,s.I)(`SELECT id, title, content, 1 - (embedding <=> $1::vector) AS score
     FROM playbooks
     ORDER BY embedding <=> $1::vector ASC
     LIMIT $2`,[n,t]);return o}s=(i.then?(await i)():i)[0],n()}catch(e){n(e)}})}};var t=require("../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),n=t.X(0,[942,860],()=>r(6278));module.exports=n})();